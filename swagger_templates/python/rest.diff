28a29
> import re
40a42,48
>     import isi.rest
> except ImportError:
> 	# This isn't really an error because the library is only used when running
> 	# on-cluster.
> 	pass
> 
> try:
45a54,59
> try:
>     # for python3
>     from urllib.parse import unquote
> except ImportError:
>     # for python2
>     from urllib import unquote
138,139d151
<                 if query_params:
<                     url += '?' + urlencode(query_params)
141,143c153,157
<                     r = self.pool_manager.request(method, url,
<                                                   body=json.dumps(body),
<                                                   headers=headers)
---
>                     r = self._submit_requests(method,
>                                               url,
>                                               query_params=query_params,
>                                               headers=headers,
>                                               body=json.dumps(body))
145,148c159,164
<                     r = self.pool_manager.request(method, url,
<                                                   fields=post_params,
<                                                   encode_multipart=False,
<                                                   headers=headers)
---
>                     r = self._submit_requests(method,
>                                               url,
>                                               query_params=query_params,
>                                               headers=headers,
>                                               post_params=post_params,
>                                               encode_multipart=False)
153,156c169,174
<                     r = self.pool_manager.request(method, url,
<                                                   fields=post_params,
<                                                   encode_multipart=True,
<                                                   headers=headers)
---
>                     r = self._submit_requests(method,
>                                               url,
>                                               query_params=query_params,
>                                               headers=headers,
>                                               post_params=post_params,
>                                               encode_multipart=True)
159,162c177,181
<                 r = self.pool_manager.request(method, url,
<                                               fields=query_params,
<                                               headers=headers)
<         except urllib3.exceptions.SSLError as e:
---
>                 r = self._submit_requests(method,
>                                           url,
>                                           query_params=query_params,
>                                           headers=headers)
>         except (urllib3.exceptions.SSLError, urllib3.exceptions.HTTPError) as e:
180a200,270
> 
>     def _submit_requests(self, method, url, query_params=None, headers=None,
>                          body=None, post_params=None, encode_multipart=None):
>         if url.startswith('papi://PAPI_LOCAL_HOST'):
>             # operating on-cluster.  use isi.rest with papi.sock instead of urllib3
>             # so we can avoid re-authenticating.
> 
>             if 'Authorization' in headers:
>                 del headers['Authorization']
> 
>             if post_params is not None:
>                 # post parameters should be passed in the message body
>                 body = post_params
>             elif body is None:
>                 # both body and post_params are none, pass in an empty body
>                 body = '{}'
> 
>             # the body field must be a string
>             if not isinstance(body, basestring):
>                 body = json.dumps(body)
> 
>             url_parts = url.partition('/platform/')[2].split('/')
>             # isi.rest will re-encode the url so decode each part.  this is stupid
>             # but needed unless someone knows a way to get send_rest_request() to
>             # not re-encode the url parts.
>             for i in range(0, len(url_parts)):
>                 url_parts[i] = unquote(url_parts[i])
> 
>             response = isi.rest.send_rest_request(isi.rest.PAPI_SOCKET_PATH,
>                                                   method=method,
>                                                   uri=url_parts,
>                                                   query_args=query_params,
>                                                   headers=headers,
>                                                   body=body,
>                                                   timeout=120)
> 
>             # we only use the headers, status, reason and body of a urllib3
>             # response object.  the response from isi.rest.set_rest_request is:
>             # [status, headers subset, body]
>             reason = 'Response code: ' + str(response[0])
>             if 'status' in response[1]:
>                 reason = response[1]['status']
>                 # the contents of the status field are: 'XXX reason_string'
>                 reason = reason[4:]
>             r = urllib3.HTTPResponse(headers=response[1],
>                                      status=response[0],
>                                      reason=reason,
>                                      body=response[2])
>         else:
>             if method in ['POST', 'PUT', 'PATCH', 'OPTIONS', 'DELETE']:
>                 if query_params:
>                     url += '?' + urlencode(query_params)
>             elif method in ['GET', 'HEAD']:
>                 post_params = query_params
>             if encode_multipart is not None:
>                 r = self.pool_manager.request(method,
>                                               url,
>                                               body=body,
>                                               fields=post_params,
>                                               headers=headers,
>                                               encode_multipart=encode_multipart)
>             else:
>                 r = self.pool_manager.request(method,
>                                               url,
>                                               body=body,
>                                               fields=post_params,
>                                               headers=headers)
>         return r
> 
> 
> 
